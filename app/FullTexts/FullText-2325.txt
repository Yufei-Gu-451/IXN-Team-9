three-dimensionalfalse-positive arteriolesfalse-positive venulestrue-positive arteriolestrue-positive venulesA wealth of detailed, high-resolution information about the 3D spatial arrangement of the microvasculature is now available due to recent advances inex vivovascular casting and image-processing technologies1,5,8. However, complete flow and pressure measurements cannot be obtained in individual vessels within 3D microvascular networks, using currentin vivoimaging techniques. Mathematical modeling techniques offer methods to address the challenge of interpreting and exploiting anatomical data in order to gain insight into microvascular function. The vessels forming the microcirculation are generally classified as arterioles, capillaries, and venules. Arteriolar and venular vessel segments connected at vascular branch points (nodes) typically form dichotomous branching trees with a hierarchy of vessel diameters. The capillaries form an interconnected network, with diameters of approximately 5-7 mum in mammalian heart and other tissues6. The primary role of the arterioles and venules is the convective transport of blood through the tissue, while capillaries carry blood close to every tissue cell, allowing for diffusive exchange of materials18. The identification of vessel types within digitally reconstructed microvascular data sets is needed for the development of theoretical models based on such data sets that incorporate functional differences between vessel types. Examples include models for flow regulation15, where active responses to vasodilator signals occur only in the arterioles, and models in which the capillary mesh is represented as a porous medium16, which may be coupled to an explicit description of arteriolar network hemodynamics. Although arterioles, venules, and capillaries may be distinguished by their vessel wall structure4, current imaging techniques are not capable of extracting this level of detail whilst simultaneously determining the structure of large microvascular networks. Alternative methods must therefore be employed to classify microvessels. Such methods should make use of available information about the topological and geometrical properties of the network, and use observed flow information where that is available. Current microvessel classification methods include those of Pries, Ley, and Gaehtgens10, in which connected diverging and converging trees are identified based on observed flow directions, and Roy, Pries, and Secomb15, which uses the same approach but with all vessels below a certain diameter classified as capillaries. In the following, the latter method is referred to as the "Pries-Roy" method. However, data on flow directions in all segments are rarely available for extensive geometrical data sets. Furthermore, capillary flow directions are not necessarily predetermined. Opposing flow directions have been observed in neighboring capillaries7, and flow patterns in capillary networks may also be subject to temporal fluctuations due to changes in upstream pressure (e.g., following dilation of arterioles), contraction of the surrounding tissue or the particulate nature of blood which is specifically relevant to capillary-sized vessels2,9. In a structure-based algorithm developed by Cassotet al. 1, the arteriolar and venular trees are identified as connected vessel segments with resistance lower than a threshold value. This algorithm does not require flow direction data, but is likely to be strongly sensitive to the threshold resistance value chosen. Once the segments forming a vessel network have been classified as arterioles, venules or capillaries, previously established methods are available to further analyze the structures of the venular and arteriolar trees, including the Horton-Strahler (centripetal) scheme and the generation (centrifugal) scheme. The advantages and disadvantages of these schemes have been discussed previously12. In this paper, our objective is to develop algorithms that exploit microvascular network geometry and topology to identify arterioles and venules within large anatomical data sets, applicable to networks for which flow measurements are not available. Two novel algorithms are presented and applied to data sets from five rat mesentery networks for which flow data are available10,13, allowing comparison with the flow-based Pries-Roy method. Our goal is to correctly identify more arterioles and venules whilst improving the robustness to parameter changes relative to the approach of Cassotet al. 1. Networks 1-4 contain one or two main arteriolar trees and one or two main venular trees, whereas network 5 has several inlets and outlets. Algorithm 1 was motivated by the study of networks with few inlets and outlets. Algorithm 2, an adaptation of the first algorithm, was developed for networks with multiple inlets in order to address the problem of extracting separate arteriolar and venular trees when these trees are located in close proximity within the network. The network data were obtained from previous experimental observations of the microcirculation of the rat mesentery using intravital microscopy10,13. In those experiments, fat-free portions of the mesenteric membrane were scanned photographically and video-recorded, and the topological connectivity of the networks and segment diameters and lengths were measured. The number of nodes, segments, inlets and outlets, and diameter properties of each network are given in Table 1. The two-dimensional coordinates of nodes were recorded in three out of the five networks (networks 1, 2 and 5), enabling computerized visualization of the network structure. Flow directions were recorded from the video recordings and red blood cell velocities were measured at the center-line of vessels using frame-to-frame correlation, with values averaged over about four seconds to remove the effect of pulsatile fluctuations from the velocity data. When measured velocities were converted to flows, conservation of mass was not precisely satisfied at all vessel junctions. To obtain a network flow solution satisfying flow conservation at nodes, recorded segment flows and discharge hematocrits were assigned as boundary conditions within an iterative solver that uses thein vivoviscosity and bifurcation laws of Prieset al. 9and Pries, Neuhaus, and Gaehtgens11, to obtain a unique solution14. Geometrical properties of mesentery networks 1-5. The numbers of arterioles, capillaries, and venules correspond to the flow-based classificationThis flow-based vessel classification method introduced by Pries, Ley, and Gaehtgens10, as modified by Roy, Pries, and Secomb15, is here considered as the "gold standard" procedure for distinguishing arterioles, capillaries, and venules. In this method, all vessels with diameter less than 8.4 mum are labeled as capillaries; this criterion is discussed below. Segment flow directions (obtained in the network flow solution as described above) are used to classify nodes as diverging (one inflow, two outflows) or converging (two inflows, one outflow). Vessels not already labeled as capillaries and forming trees connecting diverging nodes with an arteriolar input of the network are labeled as arterioles. Those connecting converging nodes with a venular output are labeled as venules, and all remaining vessels are labeled as capillaries. The minimum arteriolar diameter criterion is relevant in the context of regulation, because vessels of smaller diameter typically do not possess vascular smooth muscle and so cannot actively vasoconstrict. Here, the mean diameter of terminal arterioles (8.4 mum) in the rat intestinal muscle17was used; this could be replaced by an alternative value if known for the tissue under study. This diameter criterion leads to 25.5% fewer arterioles and 7.9% fewer venules averaged over the five mesentery networks, compared to the classifications obtained without this criterion. The number of arterioles, capillaries, and venules in each network according to the Pries-Roy method are listed in Table 1. Although this topological approach does not necessarily provide a classification which is identical to a histological identification of vessels as arterioles, capillaries or venules (which would require information on vessel wall structure, as discussed above), it represents an accurate topological description if vessel flow directions are known, and was used to test the structure-based algorithms that are introduced next. All these algorithms require prior specification of the main arteriolar inlets and venular outlets. Cassotet al. 1extracted vascular trees (arterioles and venules) from a reconstructed cerebral microvascular network using a structure-based vessel classification method. Starting at the main inlets/outlets, the technique identifies an arteriolar/venular tree by following paths along vessel segments with resistance lower than a specified critical value,Rc. Vascular resistance was defined asR = 128 muL/piD4, whereLandDare vessel length and diameter, respectively, andmuis the effective viscosity calculated via thein vitroviscosity law of Pries11with a uniform discharge hematocrit of 0.45. All other vessels with less than italic greater than R greater than R less than /italic greater than c(or withcbut separated from the main arteriolar/venular trees by high resistance vessels) are labeled as capillaries. This approach was motivated by the observation that arterioles and venules have higher diameter, and thus lower resistance, than capillaries. This algorithm (Algorithm 1) was developed to exploit intrinsic structural features of the microvasculature by identifying the transition from branching structures (arterioles and venules) to loops, which are characteristic of the interconnected capillary network. This is achieved by iteratively stepping through the vessels in a sequence that depends on both branching order and vessel diameter. The algorithm may be applied to an arbitrary network with vertices (nodes) connected by edges (segments). The required inputs are a connectivity matrix describing the network topology (i.e., the start nodes and end nodes of each segment, where the direction is arbitrary), a list of segment diameters, and the indices of the main inlet and outlet nodes, specifying the starting points of the algorithm. The first parent segmentp1is the segment connected to the main inlet node. At theith step, the daughter segments connected to all established parents (found using the connectivity matrix) constitute a list of candidate parent segments. This definition does not depend on flow directions. The next parentpNoneis selected as the candidate parent segment with the largest diameter. By this procedure, vessels with larger diameters are successively connected to the arteriolar or venular tree, reflecting the characteristic that arterioles and venules generally have larger diameters than capillaries. Each node is given a label 0 or 1; all nodes are initially labeled 0, which is changed to 1 when a segment connected to the node is found as a daughter segment. Parent vesselpNoneand its daughter vessels are then classified as follows:NoneNoneNoneNoneThe end nodes of all daughter segments are labeled 1. If the end node of a daughter segment has already been labeled 1 on a previous iteration, this indicates that a loop has been formed in the identified network and the daughter is labeled as a capillary. In that case, if the diameter ratio of the parent to the daughter is less than a specified valueDr, then the parent is also labeled as a capillary. If the parent is labeled as a capillary, then its other daughter is also labeled as capillary. If the parent is not labeled as a capillary, then it is labeled as an arteriole/venule. The algorithm ends when there are no more candidate parents. The use of the criterion based onDrenables retrospective labeling of the current parent segment when a capillary loop is reached, if the diameter of the parent is not much larger than (i.e., within a factorDrof) the diameter of the daughter vessel. Note thatDris scale-invariant, and so its value is expected to be more consistent across different networks than an absolute metric such as the critical resistanceRcused in the Cassot method. The algorithm is repeated starting from the main outlet (which becomes the newp1) to identify the venular network. Finally, any vessels not labeled as arterioles or venules are marked as capillaries. Since the algorithm is run separately to select arteriolar and venular trees, it is possible that some vessels are labeled as both arterioles and venules. This issue will be addressed in the development of Algorithm 2 in the sectionStructure-Based Algorithm for Networks with Multiple Inlets. During the process of developing this algorithm, the selection of vessels with higher diameter as parent segments was found to increase the number of identified arterioles and (more notably) venules that coincided with the flow-based classification, compared to an earlier version of the algorithm in which parent segments were selected only by generation number (defined as the number of branching points i.e., nodes fromp1to the current segment). The inclusion of the criterion based on the parent-daughter diameter ratio further improved results. A two-dimensional visualization of the classification process was developed to qualitatively evaluate the methods, and is used to illustrate specific stages of Algorithm 1 when applied to identify arterioles in mesentery network 1. The outline of the identified arteriolar tree at step 26 is shown in Figure 1A. The 1st and 3rd steps are shown in Figure 1B and C, illustrating that larger diameter vessels are preferentially added to the arteriolar tree. The region of interest forp26is shown Figure 1D. At the 27th step, the daughter vessels ofp27are labeledd1andd2. The end node of daughter vesseld2was already reached on the previous step, andd2was therefore labeled a capillary. The use of the parameterDris depicted in Figure 1F and G for steps 42 and 43 with an example value ofDr = 2. Here, daughter vesseld1formed a loop and was labeled as a capillary; the diameter of the parent vessel (12.6 mum) was less than twice the diameter ofd1(14.7 mum), and so the parent vesselp43was also labeled as a capillary. Since the parent was a capillary,d2was also labeled as a capillary, as illustrated in Figure 1G.Illustration of steps in vessel classification using Algorithm 1. (A) Overview of mesentery network 1 at step 26, with the location of magnified regions indicated. (B) The first step, with first parent segmentp1. (C) The third step, with parent vesselsp1,p2,andp3. (D) Step 26. (E) One step later,p27has two daughter vessels, one of which (d2) forms a loop and so is labeled as a capillary. (F) Step 42. (G) One step later, daughter vesseld1forms a loop and so is labeled as a capillary. The ratio of the diameters ofp43andd1is less thanDr,so parentp43is also labeled as a capillary, and consequently alsod2. Algorithm 1 was developed for networks with one or two main arteriolar and venular trees. When Algorithm 1 was applied to network 5, which contains multiple, closely positioned inlets and outlets, it did not perform well, as discussed below. Therefore, Algorithm 1 was adapted to classify all trees simultaneously, in the following procedure (Algorithm 2):NoneNoneNoneNoneNoneStarting segments (inlets and outlets) were sorted in order of descending diameter. Beginning at the largest-diameter starting segment, Algorithm 1 was implemented while parent segmentpNonehad diameter less than italic greater than D greater than = D less than /italic greater than min, whereDminis a minimum diameter threshold which must be specified. Daughter segments withminwere added to the list of candidate parent segments, but their end-nodes were not labeled 1 (so that they could not be used to form a capillary loop). Steps 2 and 3 were repeated for all remaining starting segments. Following this stage, Algorithm 1 was continued on the first tree for one step only before moving to the next tree. This was repeated until there were no more candidate parent segments. To evaluate the results of the three structure-based methods, vessels labeled as arterioles by both the structure-based method under consideration and the Pries-Roy method were marked as true positives (TPA), whereas vessels marked as arterioles by the structure-based method but not by the Pries-Roy method were marked as false positives (FPA). This was repeated for the venules (TPV and FPV). As a metric of the success of each classification, a total score was defined as the number of TPA and TPV, minus the sum of FPA and FPV. The parameter values in each algorithm (Rcin the Cassot method,Drin Algorithm 1 andDrandDminin Algorithm 2) were chosen to maximize this metric. The sensitivity of the number of true and false positive arterioles/venules and the number of overlapping segments (classified as both arterioles and venules) to a +/-10% change in parameter values was determined. All algorithms and the quantitative comparison of their results were implemented in MATLAB R2013b on a personal computer (The MathWorks, Inc., Natick, MA, USA). The number of vessels classified as each type defined above (TPA, FPA, TPV, and FPV) and the total score are shown in Figure 2A as functions of the assumed critical resistanceRc. IncreasingRcled to an increase in both the number of TPA and TPV and the number of FPA and FPV. The maximum total score summed over all five networks was 588, atRc = 280kg/mm4/sec. Figure 2B shows the dependence of the number of overlapping vessels onRc. The decline in the total score coincides with the onset of overlapping with increasingRcabove this value. The classifications of segments in networks 1, 2 and 5 withRc = 280 kg/mm4/sec are illustrated in Figure 3A, Figure 4A, and Figure 5A, respectively. Results of the Cassot method. (A) The numbers ofTPA, TPV, FPA, andFPV, and the total score summed over all five networks and (B) the numbers of overlapping segments (classified as both arterioles and venules) in each network are plotted as functions ofRc(kg/mm4/sec). Visualization of final network classifications in network 1 using (A) the Cassot method, (B) Algorithm 1, and (C) Algorithm 2. Arrows indicate the location of inlets and outlets. Red segments are arterioles, green are capillaries, and blue are venules. Visualization of final network classifications in network 2 using (A) the Cassot method, (B) Algorithm 1, and (C) Algorithm 2. Arrows indicate the location of inlets and outlets. Red segments are arterioles, green are capillaries, and blue are venules. Visualization of final network classifications in network 5 using (A) the Cassot method, (B) Algorithm 1 and (C) Algorithm 2. Arrows indicate the location of inlets and outlets. Red segments are arterioles, green are capillaries, and blue are venules. Results of the classifications by all three structure-based methods are summarized in Table 2. According to the Cassot method withRc = 280 kg/mm4/sec, 22.7% of arterioles and 64.8% of venules were true positive as a proportion of the arterioles/venules classified according to the Roy method over all five networks, while there were 0.2 FPA and 6.6 FPV on average. Results for the sensitivity of the various algorithms to parameter values are shown in Table 3. Notably, a 10% increase inRcresulted in a tree overlap of 42.0 vessels, 29.6 more FPAs, and 12.8 more FPV on average. Number of TPA, TPV, FPA, FPV, and total score for the Cassot method (withRc = 280 kg/mm4/sec), Algorithm 1 (withDr = 3.175) and Algorithm 2 (withDr = 1.25 andDmin = 16.5) applied to networks 1-5Absolute change in the number of overlapping arterioles/venules, TPA, TPV, FPA, and FPV, and the total score, as a result of varying parameter values by +/-10% in the three structure-based methods. Values are averaged over all five networks, and relative toRc = 280 kg/mm4/sec in the Cassot method,Dr = 3.175 in Algorithm 1, andDr = 1.25 andDmin = 16.5 mum in Algorithm 2The free parameter in Algorithm 1 is the parent-daughter diameter ratio,Dr. With increasingDr, the number of TPA/TPV and FPA/FPV decreased (see Figure 6A). The maximum total score summed over all five networks was 570, forDr = 3.175. At this value, there was no overlap between arteriolar and venular trees in networks 1-4, but 139 overlapping segments were present in network 5 (see Figure 6B). In this network, the overlap typically occurred when arteriolar trees connected with and followed venular trees. Algorithm 2, as described below, was developed to overcome this limitation. The final classifications for networks 1, 2, and 5 withDr = 3.175 are illustrated in Figures 3B,4B, and5B. With this value, 47.9% of arterioles and 68.0% of venules were true positives on average over all five networks, while 32.4 arterioles and 8.2 venules were false positives. Algorithm 1 was more successful than the Cassot method in identifying TPV and (more significantly) TPA, but also found many more FPA. The large number of FPA was mainly due to 129 venules according to the Roy method being falsely labeled as arterioles (of which 120 were also labeled as venules). A 10% decrease inDrled to 11.4 more overlapping vessels, with most importantly 9.6 more FPA averaged over all 5 networks; hence Algorithm 1 was less sensitive to parameter changes than the Cassot method. Results of Algorithm 1. (A) The numbers ofTPA, TPV, FPAandFPV, and the total score summed over all five networks and (B) the numbers of overlapping vessels (classified as both arterioles and venules) in each network are plotted as functions ofDr. Network 5 differs from the other four networks, in that it contains multiple inlets and outlets, and also a number of large-diameter vessels ("shunts") linking arterioles and venules. The application to Algorithm 1 to this network resulted in a large number of "overlapping" vessels classified as both arterioles and venules, as noted above. Such overlap was avoided in Algorithm 2 by analyzing all the arteriolar and venular trees in parallel, choosing the largest remaining candidate parent segment of each tree in turn. Algorithm 2 contained two free parameters:Dr(also used in Algorithm 1) and a diameter threshold,Dmin. A maximum score of 771 was achieved withDr = 1.25 andDmin = 16.5 mum. Results were not sensitive to +/-10% change toDrwith less than 7% change found in the number of TPA/TPV or FPA/FPV. Figure 7shows the performance of Algorithm 2 withDr = 1.25 for a range ofDmin. ReducingDminby 10% from 16.5 mum led to a decrease in the number of TPA by 28.8 vessels on average, and an increase (by 14.4 vessels) in the number of FPV. However, increasingDminby 10% resulted in a decrease in only 3.0 in the number of TPA, showing that this algorithm is not very sensitive to increases toDmin, but is sensitive to a reduction inDminforDmin less than 16.5 mum. The final classifications for networks 1, 2 and 5 are illustrated in Figures 3C,4C and5C. At these parameter values, 58.3% of arterioles and 84.0% of venules were true positives as a percentage of the arterioles/venules according to the Roy method, while 9.2 arterioles and 24.6 venules were false positives on average over all five networks. Thus, Algorithm 2 identified many more TPA and TPV than either the Cassot method or Algorithm 1. Algorithm 2 identified more FPA than the Cassot method but fewer than Algorithm 1, and more FPV than either method. Results of Algorithm 2. The numbers ofTPA, TPV, FPA, andFPV, and the total score summed over all five networks are plotted as functions ofDmin, forDr = 1.25. In this paper, two novel structure-based algorithms were developed to distinguish arteriolar or venular trees from interconnected microvascular networks. Both algorithms were motivated by the need to determine the transition from arterioles and venules to capillaries based on purely geometrical and topological features of the network, when studying large structural data sets without corresponding simultaneously measured flow data. Algorithm 1 depends on one parameter, the critical ratioDrbetween parent and daughter vessel diameters. Starting at specified inlet or outlet vessels, arteriolar and venular trees were identified separately and the number of vessels overlapping between trees was recorded. An adapted version of this method (Algorithm 2) ran Algorithm 1 while vessel diameters were greater thanDmin, and then alternated between inlets/outlets identifying vascular trees in parallel, and thus avoiding any overlap between trees. This method was more appropriate for networks containing many closely connected arteriolar and venular trees. These two algorithms and the existing structure-based Cassot method were implemented for five mesentery networks for which segment flows were also recorded. A novel approach was taken to test these three structure-based methods by comparison against the flow-based method, which uses measured flow directions to identify connected diverging or converging trees. Parameter values were chosen by maximizing the difference between the total number of TPA and TPV, and the number of FPA and FPV. Although the flow-based method is a topological and not a histological microvessel classification (the histological vessel type is unknown), this approach enables testing of the structure-based algorithms by exploiting the flow data available for these networks. The Cassot method performed poorly in identifying arterioles as defined by the Pries-Roy method. The likely reason is that arterioles generally have smaller diameter than corresponding venules, and this can result in flow resistance above the thresholdRc. Nonetheless, the Cassot method identified fewer false positives than either Algorithm 1 or 2. The Cassot method was sensitive to an increase inRc, with a significant rise in the number of FPA and FPV, and the number of overlapping vessels. Note also that the Pries-Roy method and the Cassot method both use diameter or resistance-based criteria, which would most likely require adjustment for other tissues with different typical capillary diameters. On the other hand, the parent-daughter diameter ratio in the algorithms introduced here could in theory be applied to other networks without modification. Comparing Algorithms 1 and 2, Algorithm 1 was shown to be the less sensitive classification method overall. Algorithm 2 was not as sensitive to changes in Dr as Algorithm 1, but a decrease in Dmin in Algorithm 2 led to a large decrease in the number of TPA and an increase in the number of FPV. Nonetheless, Algorithm 2 was much more successful than Algorithm 1 in correctly identifying arterioles and venules, found fewer FPA (though more FPV), and has the additional advantage of intrinsically avoiding classifying vessels as both arterioles and venules (overlap). For these reasons Algorithm 2 is recommended for future application to other data sets containing closely-located branching structures; however, this choice is network-specific and Algorithm 1 may be a more reliable option for networks with only one or two inlets and outlets. The difference in optimal values for parameterDr(3.175 for Algorithm 1 and 1.25 for Algorithm 2) was due to the distinction between the two methods. The value ofDrdetermines which parent vessels are retroactively labeled as capillaries. A largerDr(i.e., a more inclusive diameter ratio criterion) means that more parent vessels are labeled as capillaries, which limits the extent of the arteriolar/venular trees. In Algorithm 1, trees beginning from each inlet and outlet are selected independently with results superimposed at the end. Thus, a high value ofDris needed to restrict the arteriolar trees and avoid overlap with the venules. In Algorithm 2, vessels are classified by switching between trees, inherently avoiding overlap of arterioles and venules. Thus, theDrcriterion may be enforced more restrictively, allowing the selection of more extensive arteriolar trees. All structure-based algorithms correctly identified a fairly low proportion of arterioles relative to the Pries-Roy method e.g., only 43% TPA in network 2 via Algorithm 2. This may be at least partly explained by considering that the first capillaries branching directly from arterioles would most likely continue to diverge the flow, and so would constitute part of the arteriolar tree under the Pries-Roy method. These same methods could in future be applied to larger network structures in two or three dimensions. A general limitation of structure-based methods is that they require user input to specify the main inlets and outlets of the network under study, if these are not knowna priorias in the mesentery networks considered here. Observation of vessel diameters and distinctive anatomical features of arterioles and venules may provide a basis for identifying the main inflowing and outflowing vessels. The performance of these algorithms for networks in tissues other than the mesentery has yet to be tested. The algorithm uses the occurrence of loops to identify the capillary network. Therefore, it cannot be applied to networks with arterial arcades3, although it could be applied to the arteriolar networks distal to these arcades. These algorithms may require modification for application to other tissues. For instance, information on flow directions could be used to adjust the parameter values, or the method could be modified to make use of additional information identifying vessel types. These methods represent novel approaches to classifying micro-vessels using discrete algorithms that do not rely on flow information, and provide a basis for future development of more refined methods. Significant advances in imaging and digital reconstruction capabilities have provided large data sets on the 3D structure of microvascular networks down to the capillary level. Interpretation of these data is aided by the classification of all microvessels as arterioles, capillaries or venules. The algorithms presented in this paper allow automated identification of vessel type, in the absence of data on the distribution of blood flow in the network.